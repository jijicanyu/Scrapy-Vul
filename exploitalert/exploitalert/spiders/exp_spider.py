from scrapy.selector import Selector
from testexp.items import TestexpItem
from scrapy.http import Request
import scrapy
import time
class ExpSpider(scrapy.Spider):
    name="exp_spider"
    allowed_domains=["exploitalert.com"]
    start_urls=[
        'http://www.exploitalert.com/index.html?page=%s' for i in xrange(1,3)
    ]
    def parse(self,response):
        sels = Selector(response).xpath("//div[3]/table/tbody/tr")
        for sel in sels:
              item=TestexpItem()
              item['edb_id']=''
              item['ref_id']=''
              item['level']=''
              item['vul_score']=''
              item['vul_type']=''
              item['vul_author']=''
              item['vul_poc']=''
              item['vul_fixurl']=''
              item['vul_fix']=''
              item['vul_ref']=''
              item['application']=''
              item['app_ver']=''
              item['grab_time']=time.strftime('%Y-%m-%d')
              item['vul_access']=''
              item['snapshot'] = response.body
              item['from_site'] = 'www.exploitalert.com'
              item['public_time']=sel.xpath("td[2]/text()").extract_first()
              from_site=sel.xpath("td[3]/a/@href").extract_first() 
              item['vul_title']=sel.xpath("td[3]/a/text()").extract_first()
              item['from_site']=sel.xpath("td[3]/a/@href").extract_first()   
              if from_site =='':
                     pass

              yield Request(url=from_site,
                callback=self.parse_item,
                meta={'item':item}
                )

    def parse_item(self,response):
            item = response.meta['item']
            item['vul_detail'] = Selector(response).xpath("//body/div[@class='container']/pre[@class='language-html']").xpath("string(.)").extract_first()      

            yield item




